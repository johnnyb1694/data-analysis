---
title: "Teacher-Student Ratio Analysis"
author: "Johnny Breen"
date: "18/05/2019"
output: github_document
---

# Read in data

```{r}
library(tidyverse)
theme_set(theme_light())
# we use 'ts' to refer to 'teacher-student'
ts_ratio_raw <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-05-07/student_teacher_ratio.csv")

ts_ratio_raw 
```

# Exploratory data analysis

First, let's have a little look at how many countries we are working with:

```{r}
ts_ratio_raw %>%
  count(country) %>%
  arrange(desc(n))
```

We have 232 'countries' represented - although as you can see some of these are not countries, for example 'World'. There's a bit too many values to represent on a graph but we can see that there is a wide variety of countries here.

Let's have a look at the representation of different education levels:

```{r}
ts_ratio_raw %>%
  ggplot(aes(x = indicator)) +
  geom_bar(width = 0.5, show.legend = FALSE, aes(fill = indicator)) +
  theme(axis.text.x = element_text(angle = 45, size = 7, hjust = 1)) +
  labs(x = "Education Level",
       y = "Frequency",
       title = "Distribution of education levels")
```

There appears to be a fairly even distribution of different education levels.

Let's have a little look at how the teacher-student ratios correlate (on a linear basis) with time. This will tell us which countries are showing the most consistent changes (good or bad) over time:

```{r}
fit_mod <- function(df, ord = 1) {
  lm(year ~ I(student_ratio^ord), data = df)
}

ts_ratio_rsq <- ts_ratio_raw %>%
  add_count(country) %>%
  filter(n > 10, !is.na(student_ratio), !is.na(year)) %>% # filter on countries with at least 10 data points
  nest(-country) %>%
  mutate(linear_mod = map(data, ~ fit_mod(df = .)),
         linear_mod_summary = map(linear_mod, ~ summary(.)),
         linear_mod_rsq = map_dbl(linear_mod_summary, "r.squared"),
         linear_mod_nobs = map_int(data, ~ nrow(.))) %>%
  arrange(desc(linear_mod_rsq))

# top 15 r-squared
ts_ratio_rsq %>%
  mutate(country = fct_reorder(country, linear_mod_rsq)) %>%
  top_n(15, linear_mod_rsq) %>%
  ggplot(aes(x = country, y = linear_mod_rsq)) +
  geom_point(aes(colour = country, size = linear_mod_nobs)) +
  expand_limits(y = c(0, 1)) +
  coord_flip() +
  labs(y = "R-squared",
       x = "Country",
       title = "Top 15 most consistent nations",
       subtitle = "Results of regressing student-teacher ratios on time",
       size = "Number of observations") +
  guides(colour = "none")
```

Based on this, Hong Kong appears to be demonstrating a fairly consistent change over time. However, there are some limitations with this approach:

1. We're lumping different education categories together. This is OK if all we care about is aggregate progress but do you remember the `indicator` variable which reflect education levels? Hong Kong, for instance, has two different trajectories for two different education levels:

    ```{r}
  ts_ratio_raw %>%
      filter(str_detect(country, "Hong Kong")) %>%
      ggplot(aes(x = year, y = student_ratio)) +
      geom_point() +
      geom_smooth(method = "lm") +
      facet_wrap(~indicator) +
      labs(x = "Year",
           y = "Student-teacher ratio",
           title = "Student-teacher ratios in Hong Kong spread over time",
           subtitle = "Split by education level shows markedly different progressions")
    ```

2. Our results are based on various volumes of data - we can have a bit more confidence in the Republic of Korea or the Dominican Republic but can't really say much about Aruba at all.

3. We cannot see whether the R-squared value reflects *progresson* or *regression* - i.e. are student-teacher ratios improving in these countries or getting worse?

It is also key to note that the number of observations here does not necessarily reflect the number of years available because some countries have data on a greater number of education levels than others but as at the same year (for instance, primary and secondary education figures in 2012).

We can improve on this. Perhaps a better way to represent the data above would be to plot the volatility of student-teacher ratios on the y axis and ratio-year correlations on the x axis. This gives way to a multi-classification of different countries - for instance, a country with a highly negative ratio-year correlation and a high volatility reflects rapid improvement (remember, we want the ratios to *decrease* over time so that teachers have less students to cater to):

```{r message=FALSE, warning=FALSE}
library(ggrepel)
ts_ratio_raw %>%
  nest(-c("country", "indicator")) %>%
  mutate(linear_corr = map_dbl(data, ~ cor(.$student_ratio, .$year, use = "pairwise.complete.obs")),
         volatility = map_dbl(data, ~ sd(.$student_ratio, na.rm = TRUE)),
         nobs = map_int(data, ~ nrow(.))) %>%
  filter(nobs > 5, !indicator %in% c("World")) %>% 
  ggplot(aes(x = linear_corr, y = volatility)) +
  geom_point(aes(size = nobs, colour = indicator)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_label_repel(data = . %>% filter(abs(linear_corr) > 0.5, volatility > 4.0),
             aes(label = country), size = 2.25) +
  facet_wrap(~indicator) +
  expand_limits(x = c(-1, 1)) +
  guides(colour = "none") +
  labs(x = "Correlation between student-teacher ratio and time",
       y = "Volatility of student-teacher ratios",
       size = "Number of observations",
       title = "Summary of student-teacher ratio volatilities over time",
       subtitle = "Negative correlations and high volatilities are desirable e.g. Gambia") +
  theme(strip.text.x = element_text(size = 6.5))
  
```

# How is this ratio affected by government spending?

One approach here is to extract all of the necessary covariates associated with student-teacher ratios and investigate which of them are statistically significant:

```{r}
# read in government spending data - downloaded from the relevant source online
ts_spend_raw <- read_csv("EDULIT_DS_19052019035546163.csv")
ts_spend_clean <- ts_spend_raw %>%
  transmute(indicator = str_remove(Indicator, "Government expenditure on "),
                                             indicator = str_remove(indicator, ", US\\$ \\(millions\\)"),
                                             indicator = str_to_title(indicator),
            country_code = LOCATION,
            year = Time,
            spending_us_dollars = Value)

ts_joined <- ts_ratio_raw %>%
  left_join(ts_spend_clean, by = c("indicator", "country_code", "year"))
```

