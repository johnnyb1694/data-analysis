---
title: "Study of Cetacean Species"
author: "Johnny Breen"
date: "27/12/2018"
output: rmarkdown::github_document
---

# Introduction

This is my first ever contribution to the [TidyTuesday](https://github.com/rfordatascience/tidytuesday) challenges posted on github. In this post, I am going to analyse a dataset submitted on various cetacean species (i.e. dolphins, whales and porpoises).

As an student actuary, I take a great interest in the study of mortality and, normally, in our line of work it is the mortality of human beings that is analysed (in the context of providing life insurance and annuities). However, given that this data contains valuable information on the death rates of captive cetaceans, I'd like to make the focus of this analysis on cetacean *mortality*. According to the [WWF](http://wwf.panda.org/knowledge_hub/endangered_species/cetaceans/threats/bycatch/), one of the leading causes of premature mortality in dolphins is incidental capture (or otherwise known as by-catch). I do not doubt these claims, given that they are supported by extensive research and vocal scientific voices, and I am aware of the corrosive effect that imprisonment can have on the mental health of cetaceans through various documentaries I have watched over the past few years. 

## Preliminary Data Inspection

As a first step, let us load the cetacean data from the TidyTuesdays github repository:

```{r read_csv, warning = FALSE, message = FALSE}
library(tidyverse)
library(magrittr)
library(lubridate)
library(broom)

species_raw <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2018/2018-12-18/allCetaceanData.csv") %>%
  select(-X1) # X1 appears to be a meaningless extra variable
```

As an initial step, let us investigate the distribution of various categorical variables within the dataset. We will start with the number of different species:

```{r}
# most species are of the bottleneck & orca variety
species_raw %>%
  count(species, sort = TRUE)
```

One important driver of mortality in humans is gender type. It would be interesting to clarify whether this is replicated in cetaceans:

```{r}
# the balance of gender is fairly even - this will make our gender-based estimates more reliable
species_raw %>%
  count(sex)
```

It might also be interesting to investigate how the transition into or out of SeaWorld (notorious for its mistreatment of dolphins - see ['Blackfish'](https://en.wikipedia.org/wiki/Blackfish_(film)) affects the mortality of dolphins:

```{r}
species_raw %>%
  transmute(seaworld_ind = str_detect(transfers, regex("SeaWorld", ignore_case = TRUE))) %>%
  count(seaworld_ind)
```

## Exploratory Data Analysis

Let's focus our analysis on deceased species now. Our first step should be to filter the data on 'deceased' species and, in addition to this, engineer the life expectancy of each cetacean in the dataset. 

Questions we might be interested in answering include:

* Is there any difference in time-to-death between captured and non-captured species?
* Is the cause of death different for captured and non-captured species?

```{r}
species_deceased <- species_raw %>%
  filter(status == "Died") %>% # let's focus on species which have deceased and those for which we *know* the birth year is accurate (indicated by "a")
  mutate(time_to_death = as.integer(difftime(statusDate, originDate, units = "days")) / 365.25)
```


```{r message=FALSE}
# how does the life expectancy of dolphins differ according to acquisition type - the answer is: by some margin. Captured cetaceans appear 
species_deceased %>%
  group_by(acquisition) %>%
  summarise(avg_time_to_death = mean(time_to_death, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(acquisition = fct_reorder(acquisition, avg_time_to_death)) %>%
  ggplot(aes(x = acquisition, y = avg_time_to_death, colour = acquisition)) +
  geom_point() +
  geom_segment(aes(x = acquisition,
                   xend = acquisition,
                   y = min(avg_time_to_death, na.rm = TRUE),
                   yend = avg_time_to_death),
                   linetype = 'dashed') +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 15, 1)) +
  theme_classic() +
  labs(x = "Acquisition type",
       y = "Average life expectancy (years)",
       colour = "Acquisition type",
       title = "Analysis of cetacean life expectancies",
       subtitle = "Captured cetaceans incur significantly lower life expectancies")

# same plot as above but for species instead - a bit more illuminating
species_deceased %>%
  group_by(species) %>%
  summarise(avg_time_to_death = mean(time_to_death, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(species = fct_reorder(species, avg_time_to_death)) %>%
  top_n(10) %>%
  ggplot(aes(x = species, y = avg_time_to_death, colour = species)) +
  geom_point() +
  geom_segment(aes(x = species,
                   xend = species,
                   y = 0,
                   yend = avg_time_to_death),
                   linetype = 'dashed') +
  coord_flip() +
  expand_limits(y = 0) +
  theme_classic() +
  labs(x = "Species",
       y = "Average life expectancy (years)",
       colour = "Species",
       title = "Analysis of cetacean life expectancies",
       subtitle = "The Amazon River and Boto seem to have favourable life expectancies")

# it may appear that the Boto has an extraordinary life expectancy; however, that's only because it consists of only one observation
species_deceased %>% 
  filter(str_detect(species, "Amazon|Boto")) %>%
  select(species, originDate, statusDate, time_to_death)

```


```{r}
# construction of life expectancy confidence intervals
species_deceased_conf <- species_deceased %>%
  filter(!is.na(time_to_death)) %>%
  add_count(species) %>%
  filter(n > 1) %>% # a confidence interval does not make sense for one single value (no variance can be estimated) %>%
  select(species, time_to_death) %>%
  nest(time_to_death) %>%
  mutate(death_intervals = map(data, ~ t.test(pull(.)))) %>%
  mutate(tidy_death_intervals = map(death_intervals, ~ tidy(.))) %>%
  unnest(tidy_death_intervals) 

# plot of life expectancies associated with certain cetacean species
species_deceased_conf %>%
  filter(conf.low >= 0) %>%
  top_n(10, estimate) %>%
  mutate(species = fct_reorder(species, estimate)) %>%
  ggplot(aes(x = species, y = estimate, colour = species)) +
  geom_point() +
  geom_segment(aes(x = species,
                   xend = species,
                   y = conf.low,
                   yend = conf.high),
                   linetype = 'solid') +
  coord_flip() +
  expand_limits(y = 0) +
  theme_classic() +
  labs(x = "Species",
       y = "Average life expectancy (years)",
       colour = "Species",
       title = "Top 10 Cetacean life expectancies",
       subtitle = "Orca and Bottlenose estimates are more reliable, on the whole")
  
```

## How has the capture of dolphins evolved over time?

```{r}
species_raw %>% 
  mutate(capture_year = year(originDate)) %>%
  count(acquisition, capture_year) %>%
  ggplot(aes(x = capture_year, colour = acquisition)) +
  geom_density() +
  facet_wrap(~acquisition) +
  theme_light() +
  labs(title = "Change in acquisition patterns over time",
       subtitle = "What has caused the incidence of stillborns to increase so rapidly since 1980?",
       x = "Year of Capture",
       y = "Density",
       colour = "Acquisition Type")
  
```



