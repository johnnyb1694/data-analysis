---
title: "Study of Cetacean Species"
author: "Johnny Breen"
date: "27/12/2018"
output: rmarkdown::github_document
---

# Introduction

This is my first ever contribution to the [TidyTuesday](https://github.com/rfordatascience/tidytuesday) challenges posted on github. In this post, I am going to analyse a dataset submitted on various cetacean species (i.e. dolphins, whales and porpoises).

As an student actuary, I take a great interest in the study of mortality and, normally, in our line of work it is the mortality of human beings that is analysed (in the context of providing life insurance and annuities). However, given that this data contains valuable information on the death rates of captive cetaceans, I'd like to make the focus of this analysis on cetacean *mortality*. According to the [WWF](http://wwf.panda.org/knowledge_hub/endangered_species/cetaceans/threats/bycatch/), one of the leading causes of premature mortality in dolphins is incidental capture (or otherwise known as by-catch). I do not doubt these claims, given that they are supported by extensive research and vocal scientific voices, and I am aware of the corrosive effect that imprisonment can have on the mental health of cetaceans through various documentaries I have watched over the past few years. 

## Preliminary Data Inspection

As a first step, let us load the cetacean data from the TidyTuesdays github repository:

```{r read_csv, warning = FALSE, message = FALSE}
library(tidyverse)
library(magrittr)
library(lubridate)
library(broom)

species_raw <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2018/2018-12-18/allCetaceanData.csv") %>%
  select(-X1) # X1 appears to be a meaningless extra variable
```

As an initial step, let us investigate the distribution of various categorical variables within the dataset. We will start with the number of different species:

```{r}
# most species are of the bottleneck & orca variety
species_raw %>%
  count(species, sort = TRUE)

# a quick bar plot confirms this - we choose species with a count of above 50
species_raw %>%
  add_count(species) %>%
  filter(n >= 50) %>%
  ggplot(aes(x = species)) +
  geom_bar(width = 0.5) +
  theme_classic() +
  labs(x = "Species",
       y = "Count",
       title = "Approximate distribution of cetacean species",
       subtitle = "The vast majority of cetacean species fall into the Bottlenose type")
  theme(axis.text.x = element_text(size = 8, angle = 90))
```

One important driver of mortality in humans is gender type. It would be interesting to clarify whether this is replicated in cetaceans:

```{r}
# the balance of gender is fairly even - this will make our gender-based estimates more reliable
species_raw %>%
  count(sex)
```

It might also be interesting to investigate how the transition into or out of SeaWorld (notorious for its mistreatment of dolphins - see ['Blackfish'](https://en.wikipedia.org/wiki/Blackfish_(film)) affects the mortality of dolphins:

```{r}
species_raw %>%
  transmute(seaworld_ind = str_detect(transfers, regex("SeaWorld", ignore_case = TRUE))) %>%
  count(seaworld_ind)
```

## Exploratory Data Analysis

Let's focus our analysis on deceased species now. Our first step should be to filter the data on 'deceased' species and, in addition to this, engineer the lifespan of each cetacean in the dataset. 

We could focus our analysis solely on cetaceans where the date of birth is known to be accurate, but this would then exclude cetaceans who were born in the wild and subsequently captured - my gut feeling is that this could be an interesting splitting variable so I would like to retain this information. Just be aware that this implies the `lifespan` variable is estimated, in some cases:

```{r}
species_deceased <- species_raw %>%
  filter(status == "Died") %>% 
  mutate(lifespan = as.integer(difftime(statusDate, originDate, units = "days")) / 365.25)
```

So, now, for each species we have a known (or in the case of captured cetaceans) lifespan. I will first narrow down the scope of the fields in the data

```{r}
species_deceased_clean <- species_deceased %>%
  transmute(species, sex, accuracy, acquisition, seaworld_ind = ifelse(str_detect(transfers, regex("SeaWorld", ignore_case = TRUE)), "SeaWorld by-catch", "Other by-catch"), lifespan) %>%
  mutate_if(is.character, as.factor)

species_deceased_clean 
```

Let's first review how the lifespan of captive cetaceans vary across different species types:

```{r message=FALSE}
species_deceased_clean %>%
  group_by(species) %>%
  summarise(avg_lifespan = mean(lifespan, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(species = fct_reorder(species, avg_lifespan)) %>%
  top_n(10, avg_lifespan) %>%
  ggplot(aes(x = avg_lifespan, y = species, colour = species)) +
  geom_point(show.legend = FALSE) +
  geom_segment(aes(x = 0,
                   xend = avg_lifespan,
                   y = species,
                   yend = species),
                   linetype = 'dotted', show.legend = FALSE) +
  expand_limits(x = 0) +
  scale_x_continuous(breaks = seq(0, 35, 5)) +
  theme_classic() +
  labs(x = "Average lifespan (years)",
       y = "Species",
       title = "Analysis of captive cetacean lifespans",
       subtitle = "The Amazon River and Boto appear to have favourable lifespans")

```

It can be very tempting to draw conclusions from a plot like that which is presented above; however, it should be noted that we previously inspected the distribution of species available in the data and the *vast* majority of cetaceans fall under the 'Bottlenose' category. We can confirm the distribution of various species by quick inspection of the variable in the deceased data:

```{r}
# top 10 species
species_deceased_clean %>%
  count(species) %>%
  arrange(desc(n))

# bottom 10 species
species_deceased_clean %>%
  count(species) %>%
  arrange(n)
```

Indeed, the top 10 and bottom 10 pulls of the data, as shown above, demonstrate that the representation in each category can be pivotal when drawing conclusions from the data. What might be more instructive is to construct confidence intervals of the animal lifespan which would take into account the number of data points available on each species type:

```{r}
species_deceased_conf <- species_deceased_clean %>%
  filter(!is.na(lifespan)) %>%
  add_count(species) %>%
  filter(n > 1) %>% # a confidence interval does not make sense for one single data point
  select(species, lifespan) %>%
  nest(lifespan) %>%
  mutate(lifespan_data = map(data, ~ t.test(pull(.)))) %>% # apply the t.test function to each species
  mutate(lifespan_intervals = map(lifespan_data, ~ tidy(.))) %>% # tidy the model output generated by the t.test
  unnest(lifespan_intervals) %>%
  transmute(Species = species, avg_lifespan = estimate, lifespan_low = ifelse(conf.low < 0, 0, conf.low), lifespan_high = conf.high) # the lower end of a confidence interval can stray below zero since we are implicitly assuming that each of the species' lifespan is normally distributed - for sensibility, we set any conf.low values below zero to zero 
```

Now that we have derived a reasonable set of confidence intervals, we can plot the average survival times for each species type once again:

```{r}
# plot of life expectancies associated with certain cetacean species
species_deceased_conf %>%
  
```


